# ファイルインポート機能拡張 - 実装計画

## 現状

### 対応済みファイル形式
- ✅ PDF (`.pdf`) - `pdf-parse`ライブラリ使用
- ✅ テキスト (`.txt`, `.md`) - 直接読み込み

### 未対応ファイル形式
- ❌ PowerPoint (`.pptx`)
- ❌ Excel (`.xlsx`, `.xls`)
- ❌ Word (`.docx`, `.doc`)

## 問題

PowerPointファイルをアップロードしても、JSONとして保存されない。
- 処理時間は長いが、最終的にエラーまたは保存失敗
- テキスト抽出ができていない可能性

## 解決策

### 1. 必要なライブラリの追加

```bash
npm install mammoth        # Word (.docx) 処理
npm install xlsx           # Excel (.xlsx, .xls) 処理  
npm install pptx-parser    # PowerPoint (.pptx) 処理
```

### 2. data-processor の拡張

#### 修正ファイル
- `server/src/api/data-processor/index.mjs`

#### 追加機能
1. **PowerPoint処理**
   - `.pptx`ファイルからテキスト抽出
   - スライドごとにチャンク化

2. **Excel処理**
   - `.xlsx`, `.xls`ファイルからテキスト抽出
   - シートごとにデータ抽出
   - セル値を結合してテキスト化

3. **Word処理**
   - `.docx`ファイルからテキスト抽出
   - 段落ごとに処理

4. **エラーハンドリング強化**
   - ファイル形式ごとのエラー処理
   - 処理進捗ログの追加
   - タイムアウト設定

### 3. 対応ファイル形式一覧

| ファイル形式 | 拡張子 | ライブラリ | 状態 |
|------------|--------|-----------|------|
| テキスト | `.txt`, `.md` | 標準 | ✅ 対応済み |
| PDF | `.pdf` | `pdf-parse` | ✅ 対応済み |
| Word | `.docx` | `mammoth` | ⏭️ 実装予定 |
| Word (旧) | `.doc` | `textract` | ⏭️ 実装予定 |
| Excel | `.xlsx` | `xlsx` | ⏭️ 実装予定 |
| Excel (旧) | `.xls` | `xlsx` | ⏭️ 実装予定 |
| PowerPoint | `.pptx` | `pptx-parser` | ⏭️ 実装予定 |

### 4. 実装手順

1. ✅ 現状確認
2. ⏭️ ライブラリインストール
3. ⏭️ ファイル処理関数の実装
4. ⏭️ data-processor への統合
5. ⏭️ テスト実行
6. ⏭️ ドキュメント更新

## 検証計画

### テストファイル
- PowerPoint: 既存のアップロード済みファイル
- Excel: サンプルデータ
- Word: マニュアル文書

### 確認項目
1. ファイルアップロード成功
2. テキスト抽出成功
3. チャンク化成功
4. JSONメタデータ保存成功
5. ナレッジベース検索で検出可能

## 注意事項

> [!WARNING]
> `.doc`や`.xls`などの旧形式は、追加のライブラリ(`textract`など)が必要になる可能性があります。
> まずは`.docx`、`.xlsx`、`.pptx`の新形式に対応します。

> [!IMPORTANT]
> 大容量ファイル(10MB以上)の処理には時間がかかるため、タイムアウト設定を適切に行う必要があります。
