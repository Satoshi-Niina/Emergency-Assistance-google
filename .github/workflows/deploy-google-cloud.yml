name: Deploy to Google Cloud Run

# Êñ∞„Åó„ÅÑ„Éá„Éó„É≠„Ç§„ÅåÈñãÂßã„Åï„Çå„Åü„ÇâÂè§„ÅÑÂÆüË°å„ÇíËá™Âãï„Ç≠„É£„É≥„Çª„É´
concurrency:
  group: deploy-google-cloud-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - 'client/**'
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-google-cloud.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Google Cloud Run

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true

      - name: Force clean checkout verification
        run: |
          echo "üßπ Forcing complete clean state..."
          git clean -ffdx
          git reset --hard HEAD
          echo "‚úÖ Repository is completely clean"

      - name: Generate deployment metadata
        id: metadata
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_TIME=$(git log -1 --format=%cI)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "üìã Deployment Metadata:"
          echo "   Commit: $COMMIT_SHA"
          echo "   Time: $BUILD_TIME"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Security check - RSC & vulnerabilities
        run: |
          echo "üîç Running security vulnerability check..."
          node scripts/check-rsc-vulnerabilities.mjs
        continue-on-error: false

      # Google CloudË™çË®ºË®≠ÂÆö
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éì„É´„Éâ
      - name: Install client dependencies
        run: |
          cd client
          rm -rf node_modules package-lock.json
          npm install --no-cache
          echo "‚úÖ Fresh dependencies installed"

      - name: Create client deployment metadata
        run: |
          cd client
          mkdir -p public
          cat > public/deployment-info.json << EOF
          {
            "commit_sha": "${{ steps.metadata.outputs.commit_sha }}",
            "commit_time": "${{ steps.metadata.outputs.commit_time }}",
            "build_time": "${{ steps.metadata.outputs.build_time }}",
            "workflow_run": "${{ github.run_number }}",
            "deployed_by": "GitHub Actions",
            "platform": "Google Cloud Run"
          }
          EOF
          echo "‚úÖ Created deployment-info.json"

      - name: Build client
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_BACKEND_SERVICE_URL: ${{ secrets.VITE_BACKEND_SERVICE_URL }}
          VITE_SERVER_URL: ${{ secrets.VITE_SERVER_URL }}
          NODE_ENV: production
        run: |
          cd client
          echo "üîß Building with environment:"
          echo "   VITE_API_BASE_URL: $VITE_API_BASE_URL"
          echo "   VITE_BACKEND_SERVICE_URL: $VITE_BACKEND_SERVICE_URL"
          echo "   VITE_SERVER_URL: $VITE_SERVER_URL"
          
          if [ -z "$VITE_API_BASE_URL" ]; then
            echo "‚ùå ERROR: VITE_API_BASE_URL is not set!"
            exit 1
          fi
          
          npm run build
          echo "‚úÖ Client build completed"

      # „Çµ„Éº„Éê„Éº„Éì„É´„Éâ
      - name: Install server dependencies
        run: |
          cd server
          rm -rf node_modules package-lock.json
          npm install --no-cache
          echo "‚úÖ Server dependencies installed"

      - name: Build server
        run: |
          cd server
          npm run build
          echo "‚úÖ Server build completed"

      # Google Cloud Run„Å∏„ÅÆ„Éá„Éó„É≠„Ç§
      - name: Deploy to Cloud Run
        run: |
          # „Éó„É≠„Ç∏„Çß„ÇØ„ÉàIDË®≠ÂÆö
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          
          # Cloud Run„Å∏„Éá„Éó„É≠„Ç§
          gcloud run deploy emergency-assistance-server \
            --source server \
            --region asia-northeast1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars NODE_ENV=production,DATABASE_URL=${{ secrets.DATABASE_URL }},SESSION_SECRET=${{ secrets.SESSION_SECRET }},JWT_SECRET=${{ secrets.JWT_SECRET }},FRONTEND_URL=${{ secrets.FRONTEND_URL }},GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }},GOOGLE_CLOUD_STORAGE_BUCKET=${{ secrets.GCS_BUCKET_NAME }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},STORAGE_MODE=gcs
          
          # „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Éï„Ç°„Ç§„É´„ÇíCloud Storage„Å∏„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºàÈùôÁöÑ„Éõ„Çπ„ÉÜ„Ç£„É≥„Ç∞Ôºâ
          gsutil -m rsync -r -d client/dist gs://${{ secrets.GCS_STATIC_BUCKET_NAME }}
          
          # Cloud Storage„Éê„Ç±„ÉÉ„Éà„ÇíÂÖ¨ÈñãË®≠ÂÆö
          gsutil iam ch allUsers:objectViewer gs://${{ secrets.GCS_STATIC_BUCKET_NAME }}
          
          echo "‚úÖ Deployment completed"

      - name: Get deployed URLs
        id: get_urls
        run: |
          # Cloud Run„ÅÆ„Çµ„Éº„Éì„ÇπURL„ÇíÂèñÂæó
          SERVER_URL=$(gcloud run services describe emergency-assistance-server --region asia-northeast1 --format 'value(status.url)')
          CLIENT_URL="https://storage.googleapis.com/${{ secrets.GCS_STATIC_BUCKET_NAME }}/index.html"
          
          echo "server_url=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "client_url=$CLIENT_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Server URL: $SERVER_URL"
          echo "‚úÖ Client URL: $CLIENT_URL"

      - name: Verify deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to complete..."
          sleep 30
          
          SERVER_URL="${{ steps.get_urls.outputs.server_url }}"
          CLIENT_URL="${{ steps.get_urls.outputs.client_url }}"
          
          echo "üîç Verifying server deployment..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVER_URL/api/health" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "‚úÖ Server is accessible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Server returned HTTP $HTTP_CODE"
          fi
          
          echo "üîç Verifying client deployment..."
          CLIENT_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CLIENT_URL" || echo "000")
          
          if [ "$CLIENT_HTTP_CODE" = "200" ]; then
            echo "‚úÖ Client is accessible"
          else
            echo "‚ö†Ô∏è Client returned HTTP $CLIENT_HTTP_CODE"
          fi
          
          echo ""
          echo "‚úÖ‚úÖ‚úÖ DEPLOYMENT TO GOOGLE CLOUD COMPLETED ‚úÖ‚úÖ‚úÖ"
          echo "   Server URL: $SERVER_URL"
          echo "   Client URL: $CLIENT_URL"
          echo "   Commit: ${{ steps.metadata.outputs.commit_sha }}"
          echo "   Build time: ${{ steps.metadata.outputs.build_time }}"
