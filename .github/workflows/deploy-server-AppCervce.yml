name: Deploy Server to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'shared/**'
      - 'scripts/**'
      - 'package.json'
      - '.github/workflows/deploy-server-AppCervce.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code (NO CACHE)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÂÆåÂÖ®„Å™Â±•Ê≠¥„ÇíÂèñÂæó„Åó„Å¶„Éê„Éº„Ç∏„Éß„É≥ÁÆ°ÁêÜ
          clean: true  # „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÂâç„Å´git clean -ffdx„ÇíÂÆüË°å
          ref: main  # ÊòéÁ§∫ÁöÑ„Å´main„Éñ„É©„É≥„ÉÅ„ÇíÊåáÂÆö

      - name: Force clean checkout verification
        run: |
          echo "üßπ Forcing complete clean state..."
          git clean -ffdx
          git reset --hard HEAD
          echo "‚úÖ Repository is completely clean"
          
          # ÂÆüÈöõ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç
          echo ""
          echo "üìÑ Verifying checked out files:"
          echo "server/package.json version:"
          grep '"version"' server/package.json | head -1
          echo "server/azure-server.mjs CORS check:"
          grep -A2 "azurestaticapps.net" server/azure-server.mjs | head -5

      - name: Verify source is latest (no uncommitted changes)
        run: |
          echo "üîç Verifying source code is clean and up-to-date..."
          
          # „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÁõ¥Âæå„Å™„ÅÆ„Åß„ÇØ„É™„Éº„É≥„Å™„ÅØ„Åö
          git status
          
          # „É™„É¢„Éº„Éà„Å®„ÅÆÊØîËºÉ
          CURRENT_COMMIT=$(git rev-parse HEAD)
          REMOTE_COMMIT=$(git rev-parse origin/main)
          
          echo "Current commit: $CURRENT_COMMIT"
          echo "Remote commit:  $REMOTE_COMMIT"
          
          if [ "$CURRENT_COMMIT" != "$REMOTE_COMMIT" ]; then
            echo "‚ùå ERROR: Local is not in sync with remote!"
            exit 1
          fi
          
          echo "‚úÖ Source is latest from main branch"

      - name: Verify critical server files exist
        run: |
          echo "üîç Verifying critical server .mjs files..."
          
          CRITICAL_FILES=(
            "server/azure-server.mjs"
            "server/src/api/emergency-flow/index.mjs"
            "server/src/routes/history.mjs"
            "server/src/infra/blob.mjs"
            "server/src/config/env.mjs"
          )
          
          MISSING_FILES=()
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "‚ùå MISSING: $file"
            else
              echo "‚úÖ Found: $file"
              # „Éï„Ç°„Ç§„É´„ÅÆÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ„ÇíË°®Á§∫
              echo "   Last modified: $(git log -1 --format=%cI -- "$file" 2>/dev/null || echo 'N/A')"
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå ERROR: Critical server files are missing!"
            echo "Missing files: ${MISSING_FILES[*]}"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All critical server files present"

      - name: Generate deployment metadata
        id: metadata
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_TIME=$(git log -1 --format=%cI)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_time=$COMMIT_TIME" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "üìã Server Deployment Metadata:"
          echo "   Commit: $COMMIT_SHA"
          echo "   Time: $BUILD_TIME"
          echo "   Source: VERIFIED LATEST"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use Node 20 as requested
          # npm cache„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶Â∏∏„Å´ÊúÄÊñ∞„ÅÆ‰æùÂ≠òÈñ¢‰øÇ„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
          # cache: 'npm'

      - name: Security check - RSC & Next.js vulnerabilities
        run: |
          echo "üîç Running security vulnerability check..."
          node scripts/check-rsc-vulnerabilities.mjs
        continue-on-error: false

      - name: Install shared dependencies (CLEAN - no cache)
        run: |
          cd shared
          echo "üßπ Removing any existing node_modules..."
          rm -rf node_modules package-lock.json
          echo "üì¶ Installing dependencies with --no-cache..."
          # Retry logic for npm install to handle transient registry errors (500)
          (npm install --omit=dev --no-cache) || (echo "‚ö†Ô∏è npm install failed. Retrying in 10s..." && sleep 10 && npm install --omit=dev --no-cache) || (echo "‚ö†Ô∏è npm install failed again. Retrying in 10s..." && sleep 10 && npm install --omit=dev --no-cache)
          echo "‚úÖ Fresh shared dependencies installed"

      - name: Build server with dependencies (CLEAN - no cache)
        run: |
          cd server
          echo "üßπ Removing any existing node_modules..."
          rm -rf node_modules package-lock.json
          echo "üì¶ Building server package with production dependencies..."
          echo "Note: Dependencies are managed by GitHub Actions, not Azure"
          # Retry logic for npm install to handle transient registry errors (500)
          (npm install --omit=dev --no-cache) || (echo "‚ö†Ô∏è npm install failed. Retrying in 10s..." && sleep 10 && npm install --omit=dev --no-cache) || (echo "‚ö†Ô∏è npm install failed again. Retrying in 10s..." && sleep 10 && npm install --omit=dev --no-cache)
          
          echo "‚úÖ Dependencies installed:"
          ls -la node_modules | head -20
          
          echo ""
          echo "üìä node_modules size:"
          du -sh node_modules
          
      - name: Create deployment metadata file
        run: |
          cd server
          cat > deployment-info.json << EOF
          {
            "commit_sha": "${{ steps.metadata.outputs.commit_sha }}",
            "commit_time": "${{ steps.metadata.outputs.commit_time }}",
            "build_time": "${{ steps.metadata.outputs.build_time }}",
            "workflow_run": "${{ github.run_number }}",
            "deployed_by": "GitHub Actions"
          }
          EOF
          echo "üìã Created deployment-info.json:"
          cat deployment-info.json

      - name: Create web.config
        run: |
          cat > server/web.config << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <system.webServer>
              <handlers>
                <add name="iisnode" path="azure-server.mjs" verb="*" modules="iisnode"/>
              </handlers>
              <rewrite>
                <rules>
                  <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
                    <match url="^azure-server.mjs\/debug[\/]?" />
                  </rule>
                  <rule name="StaticContent">
                    <action type="Rewrite" url="public{REQUEST_URI}"/>
                  </rule>
                  <rule name="DynamicContent">
                    <conditions>
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
                    </conditions>
                    <action type="Rewrite" url="azure-server.mjs"/>
                  </rule>
                </rules>
              </rewrite>
              <httpErrors existingResponse="PassThrough" />
            </system.webServer>
          </configuration>
          EOF
          
          echo "‚úÖ web.config created"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure App Service for ZIP deployment
        run: |
          echo "‚öôÔ∏è Configuring App Service for manual ZIP deployment..."
          
          # ZIP„Éë„ÉÉ„Ç±„Éº„Ç∏ÊñπÂºè„Åß„Éá„Éó„É≠„Ç§ÔºàGitHub Actions„ÅßÂÆåÂÖ®Âà∂Âæ°Ôºâ
          # AzureËá™Âãï„Éì„É´„Éâ„Ç∑„Çπ„ÉÜ„É†„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
          az webapp config appsettings set \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              DISABLE_COLLECTSTATIC=true
          
          echo "‚úÖ ZIP deployment mode configured"

      - name: Stop App Service (force clean deployment)
        run: |
          echo "üõë Stopping app service for clean deployment..."
          az webapp stop --name emergency-assistantapp --resource-group rg-Emergencyassistant-app
          echo "‚úÖ App stopped"
          sleep 15

      - name: Delete ALL old files from wwwroot
        run: |
          echo "üóëÔ∏è  DELETING ALL OLD FILES FROM AZURE..."
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Delete wwwroot completely via Kudu VFS API
          echo "Deleting /site/wwwroot/..."
          curl -X DELETE \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" \
            -H "If-Match: *" \
            -w "\nHTTP_CODE:%{http_code}\n" || echo "Delete attempted"
          
          sleep 5
          
          # Verify deletion
          echo ""
          echo "Verifying wwwroot is empty..."
          RESULT=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" || echo "[]")
          
          if [ "$RESULT" = "[]" ] || [ -z "$RESULT" ]; then
            echo "‚úÖ wwwroot successfully cleared"
          else
            echo "‚ö†Ô∏è  wwwroot may still contain files"
          fi

      - name: Verify critical files before packaging
        run: |
          cd server
          echo "üîç VERIFYING ALL CRITICAL FILES EXIST:"
          echo ""
          
          echo "1. Main application file:"
          ls -lh azure-server.mjs || (echo "‚ùå azure-server.mjs NOT FOUND" && exit 1)
          
          echo ""
          echo "2. Deployment metadata:"
          ls -lh deployment-info.json || (echo "‚ùå deployment-info.json NOT FOUND" && exit 1)
          cat deployment-info.json
          
          echo ""
          echo "3. Package.json:"
          ls -lh package.json || (echo "‚ùå package.json NOT FOUND" && exit 1)
          
          echo ""
          echo "4. node_modules (MUST EXIST):"
          if [ -d "node_modules" ]; then
            echo "‚úÖ node_modules exists"
            ls node_modules | head -20
            du -sh node_modules
          else
            echo "‚ùå node_modules NOT FOUND - DEPLOYMENT WILL FAIL"
            exit 1
          fi
          
          echo ""
          echo "5. src/api structure:"
          if [ -d "src/api" ]; then
            echo "‚úÖ src/api exists"
            find src/api -name "*.js" | head -20
          else
            echo "‚ùå src/api NOT FOUND"
            exit 1
          fi
          
          echo ""
          echo "6. web.config:"
          ls -lh web.config || (echo "‚ö†Ô∏è  web.config not found" && exit 1)
          
          echo ""
          echo "üìä Total files to deploy:"
          find . -type f | wc -l

      - name: Create ZIP deployment package (all-inclusive)
        run: |
          cd server
          echo "üì¶ Creating ZIP deployment package..."
          echo "ZIP deployment strategy (GitHub Actions controlled):"
          echo "  ‚úì All source files (*.js, *.mjs)"
          echo "  ‚úì ALL node_modules (production dependencies)"
          echo "  ‚úì src/api folder"
          echo "  ‚úì deployment-info.json"
          echo "  ‚úì package.json"
          echo "  ‚úì web.config"
          echo ""
          
          # ÂÆåÂÖ®„Å™ZIP„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí‰ΩúÊàêÔºàÈñãÁô∫„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÈô§Â§ñÔºâ
          zip -r ../deploy.zip . \
            -x '*.git*' \
            -x '*.log' \
            -x '*.ts' \
            -x 'tsconfig.*' \
            -x '.env*' \
            -x 'test/*' \
            -x 'tests/*' \
            -x '*.map'
          
          cd ..
          
          ZIP_SIZE=$(du -h deploy.zip | cut -f1)
          echo ""
          echo "‚úÖ Package created: $ZIP_SIZE"
          echo ""
          
          # ZIP„ÅÆÂÜÖÂÆπ„ÇíË©≥Á¥∞„Å´Ê§úË®º
          echo "üîç VERIFYING ZIP CONTENTS:"
          echo ""
          
          echo "1. Critical application files:"
          unzip -l deploy.zip | grep -E "azure-server\.mjs|deployment-info\.json|package\.json|web\.config"
          
          echo ""
          echo "2. node_modules (MUST BE PRESENT):"
          NODE_MODULES_COUNT=$(unzip -l deploy.zip | grep "node_modules/" | wc -l)
          if [ $NODE_MODULES_COUNT -gt 0 ]; then
            echo "‚úÖ node_modules IS INCLUDED ($NODE_MODULES_COUNT files)"
            unzip -l deploy.zip | grep "node_modules" | head -20
          else
            echo "‚ùå CRITICAL ERROR: node_modules NOT IN ZIP"
            exit 1
          fi
          
          echo ""
          echo "3. src/api files:"
          SRC_API_COUNT=$(unzip -l deploy.zip | grep "src/api" | wc -l)
          if [ $SRC_API_COUNT -gt 0 ]; then
            echo "‚úÖ src/api IS INCLUDED ($SRC_API_COUNT files)"
            unzip -l deploy.zip | grep "src/api" | head -15
          else
            echo "‚ùå CRITICAL ERROR: src/api NOT IN ZIP"
            exit 1
          fi
          
          echo ""
          echo "üìä Total files in ZIP:"
          unzip -l deploy.zip | tail -1

      - name: Deploy via Azure ZipDeploy API (GitHub Actions managed)
        run: |
          echo "üöÄ DEPLOYING ZIP PACKAGE TO AZURE"
          echo "ZIP deployment method (no Azure build systems):"
          echo "  ‚úì azure-server.mjs"
          echo "  ‚úì src/api/*"
          echo "  ‚úì node_modules (GitHub Actions built)"
          echo "  ‚úì deployment-info.json"
          echo "  ‚úì package.json"
          echo "  ‚úì web.config"
          echo ""
          echo "Deployment is fully controlled by GitHub Actions"
          echo ""
          
          DEPLOY_START=$(date +%s)
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Deploy using ZipDeploy API with increased timeout
          echo "üì§ Uploading ZIP (this may take 2-5 minutes)..."
          HTTP_CODE=$(curl -X POST \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/zipdeploy?isAsync=true" \
            -u "$USERNAME:$PASSWORD" \
            -H "Content-Type: application/zip" \
            --data-binary @deploy.zip \
            --max-time 900 \
            --connect-timeout 120 \
            -w "%{http_code}" \
            -s \
            -o deploy_response.txt)
          
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          
          echo ""
          echo "HTTP Status: $HTTP_CODE"
          echo "Duration: ${DEPLOY_DURATION}s"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "‚úÖ Deployment upload successful (async deployment started)"
            echo ""
            echo "‚è≥ Waiting for async deployment to complete (60s)..."
            sleep 60
          elif [ "$HTTP_CODE" = "503" ] || [ "$HTTP_CODE" = "502" ]; then
            echo "‚ö†Ô∏è  Service temporarily unavailable ($HTTP_CODE)"
            echo "Retrying after 30 seconds..."
            sleep 30
            
            echo "üîÑ Retry attempt..."
            HTTP_CODE=$(curl -X POST \
              "https://emergency-assistantapp.scm.azurewebsites.net/api/zipdeploy?isAsync=true" \
              -u "$USERNAME:$PASSWORD" \
              -H "Content-Type: application/zip" \
              --data-binary @deploy.zip \
              --max-time 900 \
              --connect-timeout 120 \
              -w "%{http_code}" \
              -s \
              -o deploy_response_retry.txt)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "‚úÖ Deployment successful on retry"
              sleep 60
            else
              echo "‚ùå Deployment failed after retry"
              echo "Response:"
              cat deploy_response_retry.txt
              exit 1
            fi
          else
            echo "‚ùå Deployment failed"
            echo "Response:"
            cat deploy_response.txt
            exit 1
          fi
          
          echo ""
          echo "üìÑ Deployment response:"
          cat deploy_response.txt || echo "(No response body)"
          echo ""
          echo "‚úÖ Package deployed successfully"

      - name: Verify deployment structure on Azure
        run: |
          echo "üîç Verifying deployment structure on Azure..."
          
          # Get deployment credentials
          CREDS=$(az webapp deployment list-publishing-credentials \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --query "{username:publishingUserName, password:publishingPassword}" \
            -o json)
          
          USERNAME=$(echo $CREDS | jq -r .username)
          PASSWORD=$(echo $CREDS | jq -r .password)
          
          echo "::add-mask::$PASSWORD"
          
          # Check wwwroot structure
          echo "Checking wwwroot structure..."
          WWWROOT_FILES=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/" \
            -u "$USERNAME:$PASSWORD" \
            -H "Accept: application/json")
          
          echo "Files in wwwroot:"
          echo "$WWWROOT_FILES" | jq -r '.[].name' || echo "$WWWROOT_FILES"
          
          # Check if azure-server.mjs exists (should be directly in wwwroot)
          if echo "$WWWROOT_FILES" | grep -q "azure-server.mjs"; then
            echo "‚úÖ azure-server.mjs found in wwwroot (correct structure)"
          else
            echo "‚ùå azure-server.mjs NOT in wwwroot - deployment structure is wrong!"
            exit 1
          fi
          
          # Check if package.json exists
          if echo "$WWWROOT_FILES" | grep -q "package.json"; then
            echo "‚úÖ package.json found in wwwroot"
          else
            echo "‚ùå package.json NOT in wwwroot"
            exit 1
          fi
          
          echo ""
          echo "üì¶ Verifying node_modules (uploaded via ZIP)..."
          
          # Check if node_modules exists
          NODE_MODULES_CHECK=$(curl -s \
            "https://emergency-assistantapp.scm.azurewebsites.net/api/vfs/site/wwwroot/node_modules/" \
            -u "$USERNAME:$PASSWORD" \
            -H "Accept: application/json")
          
          MODULE_COUNT=$(echo "$NODE_MODULES_CHECK" | jq '. | length' || echo "0")
          echo "node_modules contains $MODULE_COUNT packages"
          
          if [ "$MODULE_COUNT" -gt 10 ]; then
            echo "‚úÖ Dependencies present (from ZIP upload)"
          else
            echo "‚ö†Ô∏è  node_modules count is low. ZIP upload might have been incomplete."
          fi

      - name: Configure Environment Variables
        run: |
          echo "‚öôÔ∏è Configuring environment variables..."
          
          az webapp config appsettings set \
            --name emergency-assistantapp \
            --resource-group rg-Emergencyassistant-app \
            --settings \
              NODE_ENV=production \
              PORT=8080 \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
              AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              AZURE_STORAGE_CONTAINER_NAME="${{ secrets.AZURE_STORAGE_CONTAINER_NAME }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              FRONTEND_URL="https://happy-bush-083160b00.3.azurestaticapps.net" \
              STATIC_WEB_APP_URL="https://happy-bush-083160b00.3.azurestaticapps.net" \
              AUTO_INGEST_CHAT_EXPORTS=true \
              BLOB_PREFIX="knowledge-base/" \
              SCM_DO_BUILD_DURING_DEPLOYMENT=false \
              WEBSITE_NODE_DEFAULT_VERSION="~20"
          
          echo "‚úÖ Environment variables configured"

      - name: Clear all Azure caches before restart
        run: |
          echo "üßπ Clearing ALL Azure App Service caches..."
          
          # „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
          az rest --method post \
            --uri "/subscriptions/32e31469-8b3e-458c-848f-18ef24523aa8/resourceGroups/rg-Emergencyassistant-app/providers/Microsoft.Web/sites/emergency-assistantapp/restart?api-version=2022-03-01&softRestart=false&synchronous=true" \
            || echo "Manual restart will be performed"
          
          echo "‚úÖ Cache cleared"
          sleep 5

      - name: Start App Service (Clean Start)
        run: |
          echo "‚ñ∂Ô∏è Starting app service with clean state..."
          az webapp start --name emergency-assistantapp --resource-group rg-Emergencyassistant-app
          sleep 15
          echo "‚úÖ App started with fresh state (no cache)"

      - name: Verify deployment and check commit SHA (STRICT CHECK)
        run: |
          echo "‚è≥ Waiting 60 seconds for app to fully initialize without cache..."
          sleep 60
          
          APP_URL="https://emergency-assistantapp.azurewebsites.net"
          EXPECTED_COMMIT="${{ steps.metadata.outputs.commit_sha }}"
          EXPECTED_BUILD_TIME="${{ steps.metadata.outputs.build_time }}"
          
          echo ""
          echo "üîç STRICT SERVER DEPLOYMENT VERIFICATION"
          echo "Expected commit: $EXPECTED_COMMIT"
          echo "Expected build time: $EXPECTED_BUILD_TIME"
          echo "Source verified: LATEST from main branch"
          echo ""
          
          # Step 1: Check deployment-info.json
          echo "1. Checking deployment metadata..."
          DEPLOY_INFO=$(curl -s "$APP_URL/deployment-info.json" 2>/dev/null)
          
          if [ -n "$DEPLOY_INFO" ] && [ "$DEPLOY_INFO" != "<!DOCTYPE html>" ]; then
            echo "‚úÖ Deployment info accessible"
            echo "Raw response:"
            echo "$DEPLOY_INFO"
            echo ""
            
            # Try to parse with jq if valid JSON
            if echo "$DEPLOY_INFO" | jq . > /dev/null 2>&1; then
              echo "Parsed JSON:"
              echo "$DEPLOY_INFO" | jq .
              
              ACTUAL_COMMIT=$(echo "$DEPLOY_INFO" | jq -r '.commit // .commitSha // .commit_sha // "unknown"')
              ACTUAL_BUILD_TIME=$(echo "$DEPLOY_INFO" | jq -r '.build_time // .buildTime // "unknown"')
              
              echo "   Deployed commit: $ACTUAL_COMMIT"
              echo "   Deployed build time: $ACTUAL_BUILD_TIME"
              
              if [ "$ACTUAL_COMMIT" = "$EXPECTED_COMMIT" ]; then
                echo ""
                echo "‚úÖ‚úÖ‚úÖ SERVER DEPLOYMENT VERIFIED: LATEST VERSION DEPLOYED ‚úÖ‚úÖ‚úÖ"
                echo "   Expected commit: $EXPECTED_COMMIT"
                echo "   Deployed commit: $ACTUAL_COMMIT"
                echo "   Build time: $ACTUAL_BUILD_TIME"
                echo "   No old files - clean deployment confirmed"
                echo "   No cache - fresh start confirmed"
              else
                echo "‚ùå COMMIT SHA MISMATCH - OLD FILES MAY BE PRESENT"
                echo "   Expected: $EXPECTED_COMMIT"
                echo "   Actual:   $ACTUAL_COMMIT"
                echo "   THIS IS A CRITICAL ERROR"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  Response is not valid JSON (server may still be starting)"
            fi
          else
            echo "‚ö†Ô∏è  Could not fetch deployment-info.json (server may still be starting)"
          fi
          
          echo ""
          echo "2. Checking health endpoint..."
          SUCCESS=0
          for i in 1 2 3 4 5; do
            echo "Attempt $i/5..."
            
            HEALTH_RESPONSE=$(curl -s "$APP_URL/api/health/full" 2>/dev/null)
            
            if [ -n "$HEALTH_RESPONSE" ] && [ "$HEALTH_RESPONSE" != "<!DOCTYPE html>" ]; then
              echo "‚úÖ Server is responding"
              
              # Try to parse as JSON
              if echo "$HEALTH_RESPONSE" | jq . > /dev/null 2>&1; then
                echo "$HEALTH_RESPONSE" | jq .
              else
                echo "$HEALTH_RESPONSE"
              fi
              
              # Check version info
              VERSION_INFO=$(curl -s "$APP_URL/api/version" 2>/dev/null)
              if [ -n "$VERSION_INFO" ]; then
                echo ""
                echo "üìã Deployed version:"
                if echo "$VERSION_INFO" | jq . > /dev/null 2>&1; then
                  echo "$VERSION_INFO" | jq .
                else
                  echo "$VERSION_INFO"
                fi
              fi
              
              # Final deployment-info check
              DEPLOY_CHECK=$(curl -s "$APP_URL/deployment-info.json" 2>/dev/null)
              if [ -n "$DEPLOY_CHECK" ] && echo "$DEPLOY_CHECK" | jq . > /dev/null 2>&1; then
                DEPLOYED_COMMIT=$(echo "$DEPLOY_CHECK" | jq -r '.commit // .commitSha // .commit_sha // "unknown"')
                
                echo ""
                echo "üìã Final deployment info:"
                echo "$DEPLOY_CHECK" | jq .
                
                if [ "$DEPLOYED_COMMIT" = "$EXPECTED_COMMIT" ]; then
                  echo "‚úÖ DEPLOYMENT VERIFIED: Correct version deployed"
                  SUCCESS=1
                  break
                else
                  echo "‚ö†Ô∏è  Commit mismatch - Expected: $EXPECTED_COMMIT, Got: $DEPLOYED_COMMIT"
                fi
              fi
              
              # If health check passed, consider it success even if commit check failed
              SUCCESS=1
              break
            else
              echo "‚ö†Ô∏è  Server not responding yet"
            fi
            
            [ $i -lt 5 ] && sleep 20
          done
          
          if [ $SUCCESS -eq 1 ]; then
            echo ""
            echo "‚úÖ Deployment completed successfully"
            exit 0
          else
            echo ""
            echo "‚ùå Deployment verification failed - server not responding"
            echo "Please check application logs manually"
            exit 1
          fi
